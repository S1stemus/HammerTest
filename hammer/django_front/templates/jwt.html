{% extends "base.html" %}

{% block content %}
    <div class="container d-flex flex-column align-items-center">
        <h1>Введите код</h1>
        <form id='login' class="w-50">
            {% csrf_token %}           
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-control" name="password" placeholder="Password" required maxlength="4" minlength="4" pattern="[0-9]{4}">
            </div>

            <div id='error' class="alert alert-danger d-none">
                <!-- Сообщение об ошибке будет отображаться здесь -->
            </div>
            <button type='button' id="button" class="btn btn-primary">Ввести</button>
        </form>       
    </div>

    <script>
        function parseJwt (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    };
    </script>
    <script>
        document.getElementById('button').addEventListener('click', () => {
            event.preventDefault();
            var password = $('#password').val();
            var number = localStorage.getItem('number');
            if(login(password,number)){
                console.log('login');
            }
            else{
                register(password,number);
            }

        });
        function login(password,number){
            fetch('http://127.0.0.1:8000/api/token/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'XCSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'username': number,
                    'password': password
                })
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            }).then(data => {
                localStorage.setItem('token', data.access);
                localStorage.setItem('refresh', data.refresh);
                localStorage.setItem('user_id', parseJwt(data.access).user_id);
                console.log(data);
                window.location.href = 'http://127.0.0.1:8000/user/'+localStorage.getItem('user_id');
                console.log('login');
            }).catch(error => {
            });
        }
        function register(password,number){
            fetch('http://127.0.0.1:8000/api/users/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'phone_number': number,
                    'password': password
                })
            }).then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Network response was not ok');
                }
            }).then(data => {
                localStorage.setItem('token', data.access);
                localStorage.setItem('refresh', data.refresh);
                localStorage.setItem('user_id', parseJwt(data.access).user_id);
                console.log(data);
                window.location.href = 'http://127.0.0.1:8000/user/'+localStorage.getItem('user_id');
                return true;
            }).catch(error => {
                return false;
            });
            
        }
        document.addEventListener('DOMContentLoaded', function() {
            username = localStorage.getItem('number');
            token = localStorage.getItem('token');
            if(username===null ||  !(token===null)){
                window.location.href = 'http://127.0.0.1:8000/register/';               
            }
            
        })
            
    </script>
{% endblock %}
